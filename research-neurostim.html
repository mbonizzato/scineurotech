<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neurostimulation | sciNeurotech Lab</title>
  <meta name="description" content="Neurostimulation research at sciNeurotech Lab - developing advanced electrical stimulation paradigms for neural repair">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="header-brand">
      <div class="container">
        <a href="index.html" class="logo">
          <img src="Logo_Poly_desktop.png" alt="Polytechnique Montr√©al" class="institution-logo">
          <div class="lab-title">
            <span class="lab-name">sciNeurotech Lab</span>
            <a href="https://www.polymtl.ca/expertises/en/bonizzato-marco" target="_blank" class="lab-pi">Marco Bonizzato</a>
          </div>
        </a>
        <div class="lang-switch">
          <button id="btn-en" class="active" onclick="setLanguage('en')">EN</button>
          <button id="btn-fr" onclick="setLanguage('fr')">FR</button>
        </div>
      </div>
    </div>
    <nav class="main-nav">
      <div class="container">
        <button class="menu-toggle" onclick="toggleMenu()">&#9776;</button>
        <ul id="nav-menu">
          <li><a href="index.html" data-en="Home" data-fr="Accueil">Home</a></li>
          <li class="dropdown">
            <a href="index.html#research" class="active" data-en="Research" data-fr="Recherche">Research</a>
            <div class="dropdown-menu">
              <a href="research-neurostim.html" data-en="Neurostimulation" data-fr="Neurostimulation">Neurostimulation</a>
              <a href="research-maths.html" data-en="Mathematical Optimization" data-fr="Optimisation math√©matique">Mathematical Optimization</a>
              <a href="research-bci.html" data-en="Brain-Computer Interfaces" data-fr="Interfaces cerveau-machine">Brain-Computer Interfaces</a>
            </div>
          </li>
          <li><a href="publications.html" data-en="Publications" data-fr="Publications">Publications</a></li>
          <li><a href="people.html" data-en="People" data-fr="√âquipe">People</a></li>
          <li><a href="positions.html" data-en="Positions" data-fr="Postes">Positions</a></li>
          <li><a href="contact.html" data-en="Contact" data-fr="Contact">Contact</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <main>
    <div class="container">
      <div class="page-title">
        <h1 data-en="Neurostimulation" data-fr="Neurostimulation">Neurostimulation</h1>
      </div>

      <!-- Neural Pulse Game -->
      <div class="neurostim-game-container">
        <h4 data-en="Neural Pulse Game" data-fr="Jeu Neural Pulse">Neural Pulse Game</h4>
        <p class="neurostim-instructions" data-en="Press Q, W, E, R when pulses reach the activation zone. Time your stimulation to target the correct limb!" data-fr="Appuyez sur Q, W, E, R lorsque les impulsions atteignent la zone d'activation. Synchronisez votre stimulation pour cibler le bon membre!">Press Q, W, E, R when pulses reach the activation zone. Time your stimulation to target the correct limb!</p>

        <div class="neurostim-game-wrapper">
          <canvas id="neurostimCanvas" width="400" height="320"></canvas>
        </div>

        <div class="neurostim-key-guide">
          <div class="neurostim-key-item"><span class="neurostim-key-badge key-q">Q</span> <span data-en="L Arm" data-fr="Bras G">L Arm</span></div>
          <div class="neurostim-key-item"><span class="neurostim-key-badge key-w">W</span> <span data-en="L Leg" data-fr="Jambe G">L Leg</span></div>
          <div class="neurostim-key-item"><span class="neurostim-key-badge key-e">E</span> <span data-en="R Leg" data-fr="Jambe D">R Leg</span></div>
          <div class="neurostim-key-item"><span class="neurostim-key-badge key-r">R</span> <span data-en="R Arm" data-fr="Bras D">R Arm</span></div>
        </div>

        <div class="neurostim-controls">
          <button id="neurostimStartBtn" class="neurostim-btn" data-en="Start Game" data-fr="Commencer">Start Game</button>
        </div>
      </div>

      <div class="page-content-simple">
        <div class="research-detail">
          <h3 data-en="Understanding Neurostimulation" data-fr="Comprendre la neurostimulation">Understanding Neurostimulation</h3>
          <p data-en="Neurostimulation uses precisely controlled electrical signals to modulate nervous system activity. In clinical settings, this technology has transformed the treatment of neurological conditions, from deep brain stimulation for Parkinson's disease to spinal cord stimulation for chronic pain. These electrical interventions work by engaging residual neural circuits, compensating for lost function, or promoting adaptive plasticity in damaged nervous systems." data-fr="La neurostimulation utilise des signaux √©lectriques pr√©cis√©ment contr√¥l√©s pour moduler l'activit√© du syst√®me nerveux. En milieu clinique, cette technologie a transform√© le traitement des conditions neurologiques, de la stimulation c√©r√©brale profonde pour la maladie de Parkinson √† la stimulation de la moelle √©pini√®re pour la douleur chronique. Ces interventions √©lectriques fonctionnent en engageant les circuits neuraux r√©siduels, en compensant les fonctions perdues ou en favorisant la plasticit√© adaptative dans les syst√®mes nerveux endommag√©s.">Neurostimulation uses precisely controlled electrical signals to modulate nervous system activity. In clinical settings, this technology has transformed the treatment of neurological conditions, from deep brain stimulation for Parkinson's disease to spinal cord stimulation for chronic pain. These electrical interventions work by engaging residual neural circuits, compensating for lost function, or promoting adaptive plasticity in damaged nervous systems.</p>
          <p data-en="Our Lab asks: can neurostimulation actually drive motor recovery? What patterns of electrical activity restore movement? Which neural circuits must be engaged? How can we personalize stimulation to each individual's unique injury and recovery trajectory?" data-fr="Notre laboratoire se demande : la neurostimulation peut-elle r√©ellement favoriser la r√©cup√©ration motrice ? Quels sch√©mas d'activit√© √©lectrique restaurent le mouvement ? Quels circuits neuraux doivent √™tre engag√©s ? Comment personnaliser la stimulation selon la blessure unique et la trajectoire de r√©cup√©ration de chaque individu ?">Our Lab asks: can neurostimulation actually drive motor recovery? What patterns of electrical activity restore movement? Which neural circuits must be engaged? How can we personalize stimulation to each individual's unique injury and recovery trajectory?</p>

          <h3 data-en="From Bench to Bedside: The Translational Arc" data-fr="Du laboratoire au chevet : l'arc translationnel">From Bench to Bedside: The Translational Arc</h3>
          <p data-en="Just as new medications are first tested in laboratory models before reaching patients, neurostimulation therapies must follow a translational pathway. We begin with fundamental questions in rodent models: mapping the neural circuits responsible for movement control, testing how electrical stimulation interacts with damaged pathways, and developing the algorithms that will eventually guide clinical systems." data-fr="Tout comme les nouveaux m√©dicaments sont d'abord test√©s sur des mod√®les de laboratoire avant d'atteindre les patients, les th√©rapies de neurostimulation doivent suivre une voie translationnelle. Nous commen√ßons par des questions fondamentales sur des mod√®les de rongeurs : cartographier les circuits neuraux responsables du contr√¥le du mouvement, tester comment la stimulation √©lectrique interagit avec les voies endommag√©es et d√©velopper les algorithmes qui guideront √©ventuellement les syst√®mes cliniques.">Just as new medications are first tested in laboratory models before reaching patients, neurostimulation therapies must follow a translational pathway. We begin with fundamental questions in rodent models: mapping the neural circuits responsible for movement control, testing how electrical stimulation interacts with damaged pathways, and developing the algorithms that will eventually guide clinical systems.</p>
          <p data-en="This preclinical work is where we discover the mechanistic principles that make therapy possible. In our laboratory, insights from rodent studies of cortical control over locomotion and grasping have directly shaped ongoing human clinical trials. The continuum from animal model to human patient isn't a one-way street; clinical observations inform our basic research questions, creating a new research cycle." data-fr="C'est dans ce travail pr√©clinique que nous d√©couvrons les principes m√©canistiques qui rendent la th√©rapie possible. Dans notre laboratoire, les d√©couvertes issues d'√©tudes sur les rongeurs concernant le contr√¥le cortical de la locomotion et de la pr√©hension ont directement fa√ßonn√© des essais cliniques humains en cours. Le continuum du mod√®le animal au patient humain n'est pas √† sens unique ; les observations cliniques informent nos questions de recherche fondamentale, cr√©ant un nouveau cycle de recherche.">This preclinical work is where we discover the mechanistic principles that make therapy possible. In our laboratory, insights from rodent studies of cortical control over locomotion and grasping have directly shaped ongoing human clinical trials. The continuum from animal model to human patient isn't a one-way street; clinical observations inform our basic research questions, creating a new research cycle.</p>

          <h3 data-en="Closing the Loop: Adaptive Neurostimulation" data-fr="Boucler la boucle : neurostimulation adaptative">Closing the Loop: Adaptive Neurostimulation</h3>
          <p data-en="Our laboratory focuses on two primary approaches to neural repair through electrical stimulation: <strong>cortical stimulation</strong> to restore movement after spinal cord injury, and <strong>deep brain stimulation (DBS)</strong> targeting the brain's motor circuits." data-fr="Notre laboratoire se concentre sur deux approches principales de r√©paration neurale par stimulation √©lectrique : la <strong>stimulation corticale</strong> pour restaurer le mouvement apr√®s une l√©sion de la moelle √©pini√®re, et la <strong>stimulation c√©r√©brale profonde (SCP)</strong> ciblant les circuits moteurs du cerveau.">Our laboratory focuses on two primary approaches to neural repair through electrical stimulation: <strong>cortical stimulation</strong> to restore movement after spinal cord injury, and <strong>deep brain stimulation (DBS)</strong> targeting the brain's motor circuits.</p>
          <p data-en="What unites these approaches is a commitment to <em>adaptive</em> neuromodulation: systems that sense neural activity in real-time and adjust stimulation accordingly. Traditional neurostimulation delivers fixed patterns of electrical pulses, essentially replaying the same signal regardless of what the nervous system is doing. This is like trying to have a conversation where you can only speak, never listen." data-fr="Ce qui unit ces approches est un engagement envers la neuromodulation <em>adaptative</em> : des syst√®mes qui d√©tectent l'activit√© neurale en temps r√©el et ajustent la stimulation en cons√©quence. La neurostimulation traditionnelle d√©livre des sch√©mas fixes d'impulsions √©lectriques, rejouant essentiellement le m√™me signal ind√©pendamment de ce que fait le syst√®me nerveux. C'est comme essayer d'avoir une conversation o√π l'on ne peut que parler, jamais √©couter.">What unites these approaches is a commitment to <em>adaptive</em> neuromodulation: systems that sense neural activity in real-time and adjust stimulation accordingly. Traditional neurostimulation delivers fixed patterns of electrical pulses, essentially replaying the same signal regardless of what the nervous system is doing. This is like trying to have a conversation where you can only speak, never listen.</p>
          <p data-en="Closed-loop systems change this. The stimulation adapts to what the brain is trying to do, supporting voluntary effort rather than overriding it." data-fr="Les syst√®mes en boucle ferm√©e changent cela. La stimulation s'adapte √† ce que le cerveau essaie de faire, soutenant l'effort volontaire plut√¥t que de le supplanter.">Closed-loop systems change this. The stimulation adapts to what the brain is trying to do, supporting voluntary effort rather than overriding it.</p>
          <p data-en="This adaptive approach reflects a deeper principle: recovery isn't about replacing lost function with technology, but about creating the conditions where the nervous system can reorganize itself. The stimulation may then serve as a guide, strengthening weak connections and gradually building back the neural infrastructure of motor control." data-fr="Cette approche adaptative refl√®te un principe plus profond : la r√©cup√©ration ne consiste pas √† remplacer les fonctions perdues par la technologie, mais √† cr√©er les conditions permettant au syst√®me nerveux de se r√©organiser. La stimulation peut alors servir de guide, renfor√ßant les connexions faibles et reconstruisant progressivement l'infrastructure neurale du contr√¥le moteur.">This adaptive approach reflects a deeper principle: recovery isn't about replacing lost function with technology, but about creating the conditions where the nervous system can reorganize itself. The stimulation may then serve as a guide, strengthening weak connections and gradually building back the neural infrastructure of motor control.</p>

          <h3 data-en="Toward Personalized Neural Repair" data-fr="Vers une r√©paration neurale personnalis√©e">Toward Personalized Neural Repair</h3>
          <p data-en="Every spinal cord injury is unique. The location and extent of damage, the configuration of surviving pathways, the individual's motor learning capacity: all of these factors determine what's possible for recovery. Our goal is to develop neurostimulation systems that can be personalized to each patient's specific needs." data-fr="Chaque l√©sion de la moelle √©pini√®re est unique. L'emplacement et l'√©tendue des dommages, la configuration des voies survivantes, la capacit√© d'apprentissage moteur de l'individu : tous ces facteurs d√©terminent ce qui est possible pour la r√©cup√©ration. Notre objectif est de d√©velopper des syst√®mes de neurostimulation personnalisables aux besoins sp√©cifiques de chaque patient.">Every spinal cord injury is unique. The location and extent of damage, the configuration of surviving pathways, the individual's motor learning capacity: all of these factors determine what's possible for recovery. Our goal is to develop neurostimulation systems that can be personalized to each patient's specific needs.</p>
          <p data-en="This requires integrating multiple technologies: high-resolution neural interfaces that can both record and stimulate with precision, computational models that predict how electrical fields interact with neural tissue, and artificial intelligence algorithms that continuously optimize stimulation parameters based on recovery progress." data-fr="Cela n√©cessite l'int√©gration de multiples technologies : des interfaces neurales haute r√©solution capables d'enregistrer et de stimuler avec pr√©cision, des mod√®les computationnels qui pr√©disent comment les champs √©lectriques interagissent avec le tissu neural, et des algorithmes d'intelligence artificielle qui optimisent continuellement les param√®tres de stimulation en fonction des progr√®s de r√©cup√©ration.">This requires integrating multiple technologies: high-resolution neural interfaces that can both record and stimulate with precision, computational models that predict how electrical fields interact with neural tissue, and artificial intelligence algorithms that continuously optimize stimulation parameters based on recovery progress.</p>
          <p data-en="We're working to build the complete translational pipeline, from establishing the fundamental neuroscience in animal models, to developing the hardware and software platforms, to designing and conducting the clinical trials that will bring these therapies to patients. It's a long arc of research, but one grounded in the conviction that we can do better than the one-size-fits-all approaches of the past. The nervous system is adaptive. Our therapies should be too." data-fr="Nous travaillons √† construire le pipeline translationnel complet, de l'√©tablissement des neurosciences fondamentales dans les mod√®les animaux, au d√©veloppement des plateformes mat√©rielles et logicielles, √† la conception et la conduite des essais cliniques qui apporteront ces th√©rapies aux patients. C'est un long arc de recherche, mais ancr√© dans la conviction que nous pouvons faire mieux que les approches uniformes du pass√©. Le syst√®me nerveux est adaptatif. Nos th√©rapies devraient l'√™tre aussi.">We're working to build the complete translational pipeline, from establishing the fundamental neuroscience in animal models, to developing the hardware and software platforms, to designing and conducting the clinical trials that will bring these therapies to patients. It's a long arc of research, but one grounded in the conviction that we can do better than the one-size-fits-all approaches of the past. The nervous system is adaptive. Our therapies should be too.</p>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-links">
        <a href="https://www.polymtl.ca/ge/" target="_blank" data-en="Department of Electrical Engineering - Polytechnique Montr√©al" data-fr="D√©partement de g√©nie √©lectrique - Polytechnique Montr√©al">Department of Electrical Engineering - Polytechnique Montr√©al</a>
        <a href="https://neurosciences.umontreal.ca/" target="_blank" data-en="Neuroscience Research Group (GRSNC) - Universit√© de Montr√©al" data-fr="Groupe de recherche en neurosciences (GRSNC) - Universit√© de Montr√©al">Neuroscience Research Group (GRSNC) - Universit√© de Montr√©al</a>
        <a href="https://mila.quebec/en" target="_blank">Mila - Quebec AI Institute</a>
        <a href="https://cibmontreal.ca/en/" target="_blank" data-en="Biomedical Engineering Institute of Montreal" data-fr="Institut de g√©nie biom√©dical de Montr√©al">Biomedical Engineering Institute of Montreal</a>
        <a href="https://circa.openum.ca/" target="_blank" data-en="Centre for Interdisciplinary Research on Montreal" data-fr="Centre de recherche interdisciplinaire sur Montr√©al">CIRCA - Universit√© de Montr√©al</a>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 sciNeurotech Lab</p>
      </div>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    // Neural Pulse Game
    //
    // Credits:
    // Neuron icons created by photo3idea_studio - Flaticon
    // https://www.flaticon.com/free-icons/neuron
    //
    (function() {
      // Polyfill for roundRect (for older browsers)
      if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
          if (w < 2 * r) r = w / 2;
          if (h < 2 * r) r = h / 2;
          this.moveTo(x + r, y);
          this.arcTo(x + w, y, x + w, y + h, r);
          this.arcTo(x + w, y + h, x, y + h, r);
          this.arcTo(x, y + h, x, y, r);
          this.arcTo(x, y, x + w, y, r);
          this.closePath();
          return this;
        };
      }

      // Game configuration
      const TRACK_COLORS = ['#1a365d', '#2c5282', '#4299e1', '#90cdf4'];
      const TRACK_KEYS = ['q', 'w', 'e', 'r'];
      const TRACK_LABELS = ['Q', 'W', 'E', 'R'];
      const LIMB_LABELS = ['L Arm', 'L Leg', 'R Leg', 'R Arm'];
      const CANVAS_WIDTH = 400;
      const CANVAS_HEIGHT = 320;
      const TRACK_COUNT = 4;
      const TRACK_WIDTH = 70;
      const TRACK_GAP = 20;
      const PULSE_HEIGHT = 30;
      const PULSE_WIDTH = 50;
      const HIT_ZONE_HEIGHT = 60;
      const HIT_ZONE_Y = CANVAS_HEIGHT - HIT_ZONE_HEIGHT - 30;
      const PULSE_SPEED = 3;
      const SPAWN_INTERVAL_MIN = 600;
      const SPAWN_INTERVAL_MAX = 1200;
      const GAME_DURATION = 60;
      const HIT_TOLERANCE = 40;

      // Game state
      let gameRunning = false;
      let score = 0;
      let combo = 0;
      let maxCombo = 0;
      let timeRemaining = GAME_DURATION;
      let pulses = [];
      let lastSpawnTime = 0;
      let nextSpawnInterval = 0;
      let animationId = null;
      let timerInterval = null;
      let audioContext = null;

      // DOM elements
      const canvas = document.getElementById('neurostimCanvas');
      const ctx = canvas.getContext('2d');
      const startBtn = document.getElementById('neurostimStartBtn');

      // Load neuron image for hit effects
      const neuronImg = new Image();
      neuronImg.src = 'neuron.png';

      // Calculate track positions (centered)
      const totalWidth = TRACK_COUNT * TRACK_WIDTH + (TRACK_COUNT - 1) * TRACK_GAP;
      const startX = (CANVAS_WIDTH - totalWidth) / 2;

      function getTrackX(trackIndex) {
        return startX + trackIndex * (TRACK_WIDTH + TRACK_GAP);
      }

      // Initialize audio
      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
      }

      // Play beep sound
      function playBeep(frequency = 660, duration = 0.1) {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'sine';
        oscillator.frequency.value = frequency;

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration);
      }


      // Get combo multiplier
      function getComboMultiplier() {
        if (combo >= 30) return 10;
        if (combo >= 20) return 5;
        if (combo >= 10) return 3;
        if (combo >= 5) return 2;
        return 1;
      }

      // Combo flash state
      let comboFlashText = '';
      let comboFlashAlpha = 0;

      // Create a new pulse
      function createPulse() {
        const track = Math.floor(Math.random() * TRACK_COUNT);
        return {
          track: track,
          y: -PULSE_HEIGHT,
          hit: false,
          missed: false
        };
      }

      // Draw the game
      function draw() {
        // Clear canvas with background
        ctx.fillStyle = '#6b7280';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

        // Draw tracks
        for (let i = 0; i < TRACK_COUNT; i++) {
          const x = getTrackX(i);

          // Track background (darker)
          ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.fillRect(x, 0, TRACK_WIDTH, CANVAS_HEIGHT);

          // Track border
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
          ctx.lineWidth = 1;
          ctx.strokeRect(x, 0, TRACK_WIDTH, CANVAS_HEIGHT);
        }

        // Draw hit zone
        ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
        ctx.fillRect(0, HIT_ZONE_Y, CANVAS_WIDTH, HIT_ZONE_HEIGHT);

        // Draw hit zone line
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, HIT_ZONE_Y + HIT_ZONE_HEIGHT / 2);
        ctx.lineTo(CANVAS_WIDTH, HIT_ZONE_Y + HIT_ZONE_HEIGHT / 2);
        ctx.stroke();

        // Draw body part icons at bottom (larger, can invade hit zone)
        const iconRadius = 24;
        for (let i = 0; i < TRACK_COUNT; i++) {
          const cx = getTrackX(i) + TRACK_WIDTH / 2;
          const cy = CANVAS_HEIGHT - 28;

          // Background circle
          ctx.fillStyle = TRACK_COLORS[i];
          ctx.beginPath();
          ctx.arc(cx, cy, iconRadius, 0, Math.PI * 2);
          ctx.fill();

          // Draw emoji
          ctx.font = '24px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          ctx.save();
          if (i === 0) {
            // Left arm - ü¶æ as-is (points left naturally)
            ctx.fillText('ü¶æ', cx, cy);
          } else if (i === 1) {
            // Left leg - ü¶ø flipped
            ctx.translate(cx, cy);
            ctx.scale(-1, 1);
            ctx.fillText('ü¶ø', 0, 0);
          } else if (i === 2) {
            // Right leg - ü¶ø as-is
            ctx.fillText('ü¶ø', cx, cy);
          } else {
            // Right arm - ü¶æ flipped
            ctx.translate(cx, cy);
            ctx.scale(-1, 1);
            ctx.fillText('ü¶æ', 0, 0);
          }
          ctx.restore();
        }

        // Draw pulses
        pulses.forEach(pulse => {
          if (pulse.hit || pulse.missed) return;

          const x = getTrackX(pulse.track) + (TRACK_WIDTH - PULSE_WIDTH) / 2;

          // Pulse glow
          ctx.shadowColor = TRACK_COLORS[pulse.track];
          ctx.shadowBlur = 10;

          // Pulse body
          ctx.fillStyle = TRACK_COLORS[pulse.track];
          ctx.beginPath();
          ctx.roundRect(x, pulse.y, PULSE_WIDTH, PULSE_HEIGHT, 8);
          ctx.fill();

          // Reset shadow
          ctx.shadowBlur = 0;

          // Pulse highlight
          ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
          ctx.beginPath();
          ctx.roundRect(x + 5, pulse.y + 3, PULSE_WIDTH - 10, PULSE_HEIGHT / 3, 4);
          ctx.fill();
        });

        // Draw hit effects
        pulses.forEach(pulse => {
          if (pulse.hitEffect > 0) {
            const x = getTrackX(pulse.track);
            // Draw green glow background
            ctx.fillStyle = `rgba(34, 197, 94, ${pulse.hitEffect * 0.3})`;
            ctx.fillRect(x, HIT_ZONE_Y, TRACK_WIDTH, HIT_ZONE_HEIGHT);
            // Draw neuron image centered in hit zone
            if (neuronImg.complete) {
              ctx.globalAlpha = pulse.hitEffect;
              const imgSize = 50;
              const imgX = x + (TRACK_WIDTH - imgSize) / 2;
              const imgY = HIT_ZONE_Y + (HIT_ZONE_HEIGHT - imgSize) / 2;
              ctx.drawImage(neuronImg, imgX, imgY, imgSize, imgSize);
              ctx.globalAlpha = 1.0;
            }
            pulse.hitEffect -= 0.12;  // Fast fade out
          }
          if (pulse.missEffect) {
            ctx.fillStyle = `rgba(239, 68, 68, ${pulse.missEffect})`;
            const x = getTrackX(pulse.track);
            ctx.fillRect(x, HIT_ZONE_Y, TRACK_WIDTH, HIT_ZONE_HEIGHT);
            pulse.missEffect -= 0.05;
          }
        });

        // Draw score/combo/time overlay
        ctx.fillStyle = 'white';
        ctx.font = 'bold 16px sans-serif';
        ctx.textBaseline = 'top';

        // Score - top left
        ctx.textAlign = 'left';
        ctx.fillText('Score: ' + score, 10, 10);

        // Combo - top center
        ctx.textAlign = 'center';
        ctx.fillText('x' + getComboMultiplier(), CANVAS_WIDTH / 2, 10);

        // Time - top right
        ctx.textAlign = 'right';
        ctx.fillText(timeRemaining + 's', CANVAS_WIDTH - 10, 10);

        // Draw combo flash (center of screen)
        if (comboFlashAlpha > 0) {
          ctx.fillStyle = `rgba(255, 255, 255, ${comboFlashAlpha})`;
          ctx.font = 'bold 48px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(comboFlashText, CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 - 20);
          comboFlashAlpha -= 0.03;
        }
      }

      // Update game state
      function update(timestamp) {
        if (!gameRunning) return;

        // Spawn new pulses
        if (timestamp - lastSpawnTime > nextSpawnInterval) {
          pulses.push(createPulse());
          lastSpawnTime = timestamp;
          nextSpawnInterval = SPAWN_INTERVAL_MIN + Math.random() * (SPAWN_INTERVAL_MAX - SPAWN_INTERVAL_MIN);
        }

        // Update pulse positions
        pulses.forEach(pulse => {
          if (!pulse.hit && !pulse.missed) {
            pulse.y += PULSE_SPEED;

            // Check if pulse was missed (passed hit zone)
            if (pulse.y > HIT_ZONE_Y + HIT_ZONE_HEIGHT + HIT_TOLERANCE) {
              pulse.missed = true;
              pulse.missEffect = 0.5;
              combo = 0;
              updateDisplay();
            }
          }
        });

        // Clean up old pulses
        pulses = pulses.filter(p => p.y < CANVAS_HEIGHT + 50 || p.hitEffect > 0 || p.missEffect > 0);
      }

      // Game loop
      function gameLoop(timestamp) {
        update(timestamp);
        draw();

        if (gameRunning) {
          animationId = requestAnimationFrame(gameLoop);
        }
      }

      // Handle key press
      function handleKeyPress(event) {
        if (!gameRunning) return;

        const key = event.key.toLowerCase();
        const trackIndex = TRACK_KEYS.indexOf(key);

        if (trackIndex === -1) return;

        // Find pulse in hit zone for this track
        const hitZoneCenter = HIT_ZONE_Y + HIT_ZONE_HEIGHT / 2;
        let hitPulse = null;

        for (const pulse of pulses) {
          if (pulse.track === trackIndex && !pulse.hit && !pulse.missed) {
            const pulseCenter = pulse.y + PULSE_HEIGHT / 2;
            if (Math.abs(pulseCenter - hitZoneCenter) < HIT_TOLERANCE) {
              hitPulse = pulse;
              break;
            }
          }
        }

        if (hitPulse) {
          // Successful hit
          hitPulse.hit = true;
          hitPulse.hitEffect = 0.8;

          const oldMultiplier = getComboMultiplier();
          combo++;
          if (combo > maxCombo) maxCombo = combo;
          const newMultiplier = getComboMultiplier();

          // Flash combo if tier changed
          if (newMultiplier > oldMultiplier) {
            comboFlashText = 'x' + newMultiplier;
            comboFlashAlpha = 1.0;
          }

          score += 100 * newMultiplier;

          playBeep(440 + trackIndex * 110, 0.1);
          updateDisplay();
        } else {
          // Missed (no pulse in zone)
          combo = 0;
          updateDisplay();

          // Visual feedback for wrong press
          const fakePulse = { track: trackIndex, missEffect: 0.3 };
          pulses.push(fakePulse);
          setTimeout(() => {
            const idx = pulses.indexOf(fakePulse);
            if (idx > -1) pulses.splice(idx, 1);
          }, 300);
        }
      }

      // Update display (now drawn on canvas in draw())
      function updateDisplay() {
        // Stats are rendered directly on canvas
      }

      // Start game
      function startGame() {
        initAudio();

        gameRunning = true;
        score = 0;
        combo = 0;
        maxCombo = 0;
        timeRemaining = GAME_DURATION;
        pulses = [];
        lastSpawnTime = 0;
        nextSpawnInterval = 500;

        updateDisplay();
        startBtn.disabled = true;

        // Start timer
        timerInterval = setInterval(() => {
          timeRemaining--;

          if (timeRemaining <= 0) {
            endGame();
          }
        }, 1000);

        // Start game loop
        animationId = requestAnimationFrame(gameLoop);
      }

      // End game
      function endGame() {
        gameRunning = false;

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }

        startBtn.disabled = false;

        // Draw final screen
        draw();
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

        ctx.fillStyle = 'white';
        ctx.font = 'bold 32px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Game Over', CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 - 40);

        ctx.font = '20px sans-serif';
        ctx.fillText('Score: ' + score, CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 + 10);
        ctx.fillText('Max Combo: x' + getComboMultiplierForCombo(maxCombo), CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2 + 45);
      }

      function getComboMultiplierForCombo(c) {
        if (c >= 30) return 10;
        if (c >= 20) return 5;
        if (c >= 10) return 3;
        if (c >= 5) return 2;
        return 1;
      }

      // Handle click/touch on canvas
      function handleCanvasClick(event) {
        if (!gameRunning) return;

        event.preventDefault();

        // Get click position relative to canvas
        const rect = canvas.getBoundingClientRect();
        const scaleX = CANVAS_WIDTH / rect.width;
        const scaleY = CANVAS_HEIGHT / rect.height;

        let clientX, clientY;
        if (event.touches && event.touches.length > 0) {
          clientX = event.touches[0].clientX;
          clientY = event.touches[0].clientY;
        } else {
          clientX = event.clientX;
          clientY = event.clientY;
        }

        const x = (clientX - rect.left) * scaleX;
        const y = (clientY - rect.top) * scaleY;

        // Check if click is in the hit zone area (bottom portion of canvas)
        if (y >= HIT_ZONE_Y - 20) {
          // Determine which track was clicked
          for (let i = 0; i < TRACK_COUNT; i++) {
            const trackX = getTrackX(i);
            if (x >= trackX && x <= trackX + TRACK_WIDTH) {
              // Simulate key press for this track
              handleKeyPress({ key: TRACK_KEYS[i] });
              break;
            }
          }
        }
      }

      // Initialize
      function init() {
        draw();
        startBtn.addEventListener('click', startGame);
        document.addEventListener('keydown', handleKeyPress);
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', handleCanvasClick);
      }

      // Start when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
